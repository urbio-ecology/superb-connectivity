---
title: "Brief Exploration of results"
author: "Nicholas Tierney"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format: html
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = TRUE)
## target knits qmds in their own session, so load libraries here.
source(here::here("packages.R"))
tar_source()  # not always necessary
```

```{r}
#| label: load-targets
#| include: false
withr::with_dir(here::here(), {
tar_load(habitat_raster)
tar_load(barrier_raster)
tar_load(buffered_habitat)
tar_load(patch_id_raster)
tar_load(terra_areas_connected)
tar_load(results_connect_habitat)
})
```

## Exploration

```{r}
col2hex <- function(color_name) {
  rgb(t(col2rgb(color_name)), maxColorValue = 255)
}

# col2hex("forestgreen")
```

## Habitat, Buffered Habitat, and Barrier

```{r}
#| echo: false
library(terra)
library(tidyterra)
library(colorspace)
library(marquee)

plot_barrier_habitat_buffer <- function(barrier, buffer, habitat){
  # colorspace::hcl_palettes(type = "Qualitative", plot = TRUE)

# geo_cols <- colorspace::qualitative_hcl(n = 5, palette = "Dark 3") |> as.list()
geo_cols <- scico::scico(n = 6, palette = "bukavu") |> as.list()

names(geo_cols) <- c("dark_blue", "mid_blue", "light_blue", "dark_green", "tan", "offwhite")
# geo_cols |> swatchplot()
  col_barrier <- geo_cols$mid_blue
  col_habitat <- geo_cols$dark_green
  col_buffer <- geo_cols$tan
  
# First, reclassify your rasters to assign actual color values
barrier_coloured <- subst(barrier, 1, col_barrier)
buffer_coloured <- subst(buffer, 1, col_buffer)
habitat_coloured <- subst(habitat, 1, col_habitat)

# Now plot them in layers (bottom to top)
ggplot() +
  geom_spatraster(data = buffer_coloured) +
  geom_spatraster(data = barrier_coloured) +
  geom_spatraster(data = habitat_coloured) +
  theme_minimal(paper = geo_cols$offwhite) +
  scale_fill_identity(na.value = NA) +
 labs(title = marquee_glue("{.{col_habitat} Habitat}, buffered {.{col_buffer} habitat}, and {.{col_barrier} barriers}")) +
  theme(plot.title = element_marquee())
}

```

```{r}
plot_barrier_habitat_buffer(
  barrier = barrier_raster,
  buffer = buffered_habitat[[1]],
  habitat = habitat_raster
) +
  labs(subtitle = "125m buffer")

plot_barrier_habitat_buffer(
  barrier = barrier_raster,
  buffer = buffered_habitat[[2]],
  habitat = habitat_raster
) + 
  labs(subtitle = "250m buffer")

```


## Patch ID

```{r}
my_colours <- colorspace::qualitative_hcl(n = 7)

raster_patches <- as.factor(patch_id_raster[[1]])

unique_vals <- unique(values(raster_patches))
unique_vals <- unique_vals[!is.na(unique_vals)]

# assign colours cyclically
colour_indices <- ((unique_vals - 1) %% 7) + 1
colour_map <- my_colours[colour_indices]
names(colour_map) <- as.character(unique_vals)

ggplot() +
  geom_spatraster(data = raster_patches) +
  scale_fill_manual(values = colour_map, na.value = NA) +
  theme_minimal() +
  theme(legend.position = "none")
```


Explore results

```{r}
#| label: display-areas
terra_areas_connected |> 
  mutate(across(starts_with("area"), \(x) round(x, 3))) |> 
  datatable()
```

```{r}
#| label: display-connectivity
terra_areas_connected |> 
  mutate(across(where(is.numeric), \(x) round(x, 6))) |> 
  pivot_longer(
    cols = everything(),
    names_to = "Variable",
    values_to = "Value"
  ) |> 
  datatable()
```

```{r}
results_connect_habitat |> datatable()
```


## Running time

It is useful to understand how long the pipeline takes, let's take a look at the timing of some key targets

```{r}
#| label: running-time
target_timings <- tar_meta() |> dplyr::select(name, bytes, seconds)

target_timings |> 
  drop_na() |> 
  arrange(desc(seconds)) |> 
  mutate(
    bytes_pretty = prettyunits::pretty_bytes(bytes),
    .after = bytes
  ) |> 
  rename(
    target_name = name,
    runtime_seconds = seconds
  ) |> 
  datatable()

# target_timings |> 
#   filter(
#     name %in% c(
#       "vect_areas_connected",
#       "terra_areas_connected"
#     )
#   )
```


## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
