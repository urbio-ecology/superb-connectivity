---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# superb-connectivity

<!-- badges: start -->
<!-- badges: end -->

The goal of superb-connectivity is to demonstrate a workflow of connectivity analysis for the superb fairy wren. The code has been lightly adapted from [urbanConnect](https://github.com/urbio-ecology/urbanConnect), with the overall method being developed by Holly Kirk et al., in ["Ecological connectivity as a planning tool for the conservation of wildlife in cities"](https://www.sciencedirect.com/science/article/pii/S2215016122003636?via%3Dihub).

## Comparison of use of {terra} and {raster} packages and approaches


```{r include=FALSE}
#| label: setup
source("packages.R")
dir_map(path = "R/", fun = source)
# baseline total habitat areas needed for comparison (in m2 not Ha)
barrier <- read_geometry(here("data/allSFWRoads.shp")) |> st_as_sf()
habitat <- read_geometry(here("data/superbHab.shp")) |> clean() |> st_as_sf()
```

Using `{terra}`

```{r}
#| label: terra-pkg-prepare
prepared_rasters <- terra_prepare_rasters(
  habitat = habitat,
  barrier = barrier,
  base_resolution = 10,
  overlay_resolution = 500
)

habitat_raster <- prepared_rasters$habitat_raster
barrier_raster <- prepared_rasters$barrier_raster
```


```{r}
#| label: terra-pkg-analysis
terra_areas_connected <- terra_habitat_connectivity(
  habitat = habitat_raster,
  barrier = barrier_raster,
  distance = 250
)

summarise_connectivity(
  area_squared = terra_areas_connected$area_squared,
  area_total = terra_areas_connected$area
)

```


Using `{raster}`

```{r}
#| label: raster-prepare
prepared_rasters <- prepare_rasters(
  habitat = habitat,
  barrier = barrier,
  base_resolution = 10,
  overlay_resolution = 500
)

habitat_raster <- prepared_rasters$habitat_raster
barrier_raster <- prepared_rasters$barrier_raster
```

(ran into issues getting this to run on render so these results are pasted in)

```{r}
#| label: raster-analysis
#| eval: false
# and as one step
rast_areas_connected <- rast_habitat_connectivity(
  habitat = habitat_raster,
  barrier = barrier_raster,
  distance = 250
)
```

```
✔ Creating barrier mask [207ms]
✔ Removing habitat underneath barrier [56ms]
✔ Adding buffer of 250m to habitat layer [35.5s]
✔ Fragmenting habitat layer along barrier intersection [64ms]
✔ Assigning patches ID to fragments [1.7s]
✔ Summarising area in each patch [22ms]
There were 50 or more warnings (use warnings() to see the first 50)
```


```{r}
#| eval: false
summarise_connectivity(
  area_squared = rast_areas_connected$area_squared,
  area_total = rast_areas_connected$area
)
```

```
# A tibble: 1 × 5
  n_patches prob_connectedness effective_mesh_ha patch_area_mean patch_area_total_ha
      <int>              <dbl>             <dbl>           <dbl>               <dbl>
1       149          0.0000236              345.          98148.               1462.
```
